{% extends 'base.html' %}

{% block content %}
<div class="vote-box">
    <h2>Room: {{ room }}</h2>
    <h3>Task: {{ task.title }}</h3>

    {% if is_admin %}
    <form method="POST">
        <label for="task_title">Task Title:</label>
        <input type="text" name="task_title" id="task_title" placeholder="Enter task title" required>
        <button type="submit">Set Task</button>
    </form>
    {% endif %}

    <div id="voting-section">
        <h4>Vote:</h4>
        <div id="cards">
            {% for value in [1, 2, 3, 5, 8, 13, 21] %}
            <button id="vote-btn-{{ value }}" onclick="submitVote({{ value }})">{{ value }}</button>
            {% endfor %}
        </div>
    </div>

    {% if is_admin %}
    <button id="stop-vote-btn" onclick="stopVote()">Stop Vote</button>
    <button id="reset-vote-btn" onclick="resetVote()">Recommencer le vote</button>
    {% endif %}

    <div id="results" style="display: none;">
        <h4>Résultats :</h4>
        <p id="unanimity-message" style="display: none;"></p>
        <p id="lowest" style="display: none;"></p>
        <p id="highest" style="display: none;"></p>
        {% if is_admin %}
        <button id="new-task-btn" style="display: none;" onclick="newTask()">Nouvelle tâche</button>
        {% endif %}
    </div>
</div>

<script type="text/javascript">
    var socket = io();
    var hasVoted = false; // Suivi local pour l'utilisateur actuel

    // Fonction pour soumettre un vote
    function submitVote(value) {
        if (hasVoted) {
            alert("Vous avez déjà voté !");
            return;
        }
        socket.emit("submit_vote", { vote: value }); // Envoyer le vote au serveur
    }

    // Désactiver les boutons pour l'utilisateur ayant voté
    socket.on("vote_submitted", function(data) {
        if (data.name === "{{ name }}") {
            hasVoted = true;
            const buttons = document.querySelectorAll("#cards button");
            buttons.forEach(button => button.disabled = true); // Désactiver tous les boutons
        }
    });

    // Réactiver les boutons et effacer les résultats après une réinitialisation
    socket.on("vote_reset", function() {
        hasVoted = false;
        const buttons = document.querySelectorAll("#cards button");
        buttons.forEach(button => button.disabled = false); // Réactiver tous les boutons

        // Réinitialiser l'affichage des résultats
        document.getElementById("results").style.display = "none";
        document.getElementById("unanimity-message").style.display = "none";
        document.getElementById("lowest").style.display = "none";
        document.getElementById("highest").style.display = "none";
        document.getElementById("new-task-btn").style.display = "none";
    });

    // Fonction pour arrêter le vote (admin uniquement)
    function stopVote() {
        socket.emit("stop_vote", {}); // Envoyer un événement pour arrêter le vote
    }

    // Fonction pour recommencer le vote (admin uniquement)
    function resetVote() {
        if (confirm("Êtes-vous sûr de vouloir recommencer le vote ? Tous les résultats et votes seront effacés.")) {
            socket.emit("reset_vote", {}); // Envoyer un événement pour réinitialiser le vote
        }
    }

    // Afficher les résultats ou un message d'unanimité
    socket.on("voting_results", function(data) {
        const resultsDiv = document.getElementById("results");
        const unanimityMessage = document.getElementById("unanimity-message");
        const lowestResult = document.getElementById("lowest");
        const highestResult = document.getElementById("highest");
        const newTaskBtn = document.getElementById("new-task-btn");

        resultsDiv.style.display = "block";

        if (data.unanimous) {
            // Afficher le message d'unanimité
            unanimityMessage.style.display = "block";
            unanimityMessage.innerText = `Les joueurs ont tous voté à l'unanimité : ${data.vote}`;

            // Cacher les autres résultats
            lowestResult.style.display = "none";
            highestResult.style.display = "none";

            // Afficher le bouton pour une nouvelle tâche
            newTaskBtn.style.display = "block";
        } else {
            // Cacher le message d'unanimité
            unanimityMessage.style.display = "none";

            // Afficher les résultats habituels
            lowestResult.style.display = "block";
            highestResult.style.display = "block";
            lowestResult.innerText = `Plus bas : ${data.lowest.name} (${data.lowest.vote})`;
            highestResult.innerText = `Plus haut : ${data.highest.name} (${data.highest.vote})`;

            // Cacher le bouton pour une nouvelle tâche
            newTaskBtn.style.display = "none";
        }
    });

    // Fonction pour créer une nouvelle tâche
    function newTask() {
        const taskTitle = prompt("Entrez le titre de la nouvelle tâche :");
        if (taskTitle) {
            socket.emit("new_task", { title: taskTitle }); // Envoyer un événement pour créer une nouvelle tâche
        }
    }

    // Mise à jour de l'interface après la création d'une nouvelle tâche
    socket.on("task_updated", function(data) {
        alert(`Nouvelle tâche : ${data.title}`);
        location.reload(); // Recharger la page pour redémarrer le processus
    });
</script>
{% endblock %}
